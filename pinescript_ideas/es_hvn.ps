//@version=6
indicator('ES HVN', overlay=true)

// ===== Input Settings =====
// Price Levels Display
lineColor = input.color(color.green, 'Line Color')
lineLength = input.int(10, 'Line Length', minval=1)
lineThickness = input.int(1, 'Line Thickness', minval=1, maxval=5)
lineStyleInput = input.string('Solid', 'Line Style', options=['Solid', 'Dashed', 'Dotted'])
lineOffset = input.int(5, 'Line Offset', minval=0)

// Text Labels
textXOffsetBars = input.int(10, 'Text X Offset (Bars)', minval=-50, maxval=50)
textYOffsetPrice = input.float(0.0, 'Text Y Offset (Price)', minval=-100.0, maxval=100.0, step=0.1)
textSizeInput = input.string('Normal', 'Text Size', options=['Tiny', 'Small', 'Normal', 'Large', 'Huge'])

// Auto-Segments
priceReference = input.string('Close', 'Price Reference', options=['Close', 'High', 'Low', 'HL2'])
segmentsAbove = input.int(2, 'Segments Above', minval=0, maxval=10)
segmentsBelow = input.int(2, 'Segments Below', minval=0, maxval=10)
bufferPoints = input.float(10.0, 'Buffer Points', minval=0, step=10)

// Daily High/Low
showDailyLevels = input.bool(true, 'Show Daily High/Low')
dailyHighColor = input.color(color.red, 'Daily High Color')
dailyLowColor = input.color(color.blue, 'Daily Low Color')
dailyLineThickness = input.int(2, 'Daily Line Thickness', minval=1, maxval=5)
dailyLineStyle = input.string('Solid', 'Daily Line Style', options=['Solid', 'Dashed', 'Dotted'])

// Alerts
alertOnPriceLevels = input.bool(true, 'Alert on Price Levels')
alertOnDailyLevels = input.bool(true, 'Alert on Daily High/Low')
alertOnBothConditions = input.bool(true, 'Alert on Both Conditions')
alertPriceTolerance = input.float(2.0, 'Alert Price Tolerance', minval=0.1, step=0.1)

// ===== Style Conversions =====
lineStyle = switch lineStyleInput
    'Dashed' => line.style_dashed
    'Dotted' => line.style_dotted
    => line.style_solid

textSize = switch textSizeInput
    'Tiny' => size.tiny
    'Small' => size.small
    'Large' => size.large
    'Huge' => size.huge
    => size.normal

dailyLineStyleConverted = switch dailyLineStyle
    'Dashed' => line.style_dashed
    'Dotted' => line.style_dotted
    => line.style_solid

// ===== Price Levels Data =====
// Segment Boundaries (50-point intervals)
segmentBoundaries = array.from<float>(6700, 6650, 6600, 6550, 6500, 6450, 6400, 6350, 6300, 6250, 6200, 6150, 6100, 6050, 6000, 5950, 5900, 5850, 5800, 5750, 5700, 5650, 5600, 5550, 5500, 5450, 5400, 5350, 5300, 5250, 5200, 5150)

// ES (S&P 500) Price Levels Array
prices = array.from<float>(
    6686.5, 6683.0, 6454.0, 6424.0, 6410.0, 6402.0, 6370.0, 6363.0, 6346.0, 6333.0,
    6320.0, 6293.0, 6287.0, 6260.0, 6244.0, 6218.0, 6188.0, 6145.0, 6095.0, 6062.0,
    6051.0, 6040.0, 6030.0, 6023.0, 6015.0, 6004.0, 6000.0, 5980.0, 5968.0, 5960.0,
    5950.0, 5933.0, 5918.0, 5908.0, 5903.0, 5895.0, 5883.0, 5876.0, 5869.0, 5864.0,
    5857.0, 5838.0, 5824.5, 5815.5, 5811.5, 5808.5, 5797.5, 5791.5, 5772.5, 5767.5,
    5762.5, 5753.5, 5650.5, 5630.5, 5627.5, 5610.0, 5600.0, 5589.25, 5582.0, 5571.5,
    5565.0, 5559.75, 5552.5, 5547.5, 5545.75, 5542.5, 5537.5, 5526.25, 5519.0, 5498.75,
    5482.25, 5463.25, 5449.0, 5431.0, 5417.5, 5390.0, 5373.75, 5365.5, 5351.5, 5343.0,
    5336.75, 5320.0, 5278.25, 5231.25, 5227.75, 5206.0)

// ===== Core Functions =====
getReferencePrice() =>
    switch priceReference
        'High' => high
        'Low' => low
        'HL2' => hl2
        => close

findCurrentSegment(float refPrice) =>
    currentSegment = -1
    for i = 1 to array.size(segmentBoundaries) - 1
        upperBound = array.get(segmentBoundaries, i - 1)
        lowerBound = array.get(segmentBoundaries, i)
        if refPrice <= upperBound and refPrice > lowerBound
            currentSegment := i - 1
            break
    currentSegment

shouldShowPrice(float price, int currentSegment, float refPrice) =>
    if currentSegment == -1
        false
    else
        startSegment = math.max(0, currentSegment - segmentsAbove)
        endSegment = math.min(array.size(segmentBoundaries) - 2, currentSegment + segmentsBelow)
        
        showPrice = false
        for i = startSegment to endSegment
            upperBound = array.get(segmentBoundaries, i)
            lowerBound = array.get(segmentBoundaries, i + 1)
            if price <= upperBound and price > lowerBound
                showPrice := true
                break
        showPrice

// ===== Drawing Management =====
var line[] priceLines = array.new_line()
var label[] priceLabels = array.new_label()

cleanupPriceLevels() =>
    if array.size(priceLines) > 0
        for i = 0 to array.size(priceLines) - 1
            line.delete(array.get(priceLines, i))
        array.clear(priceLines)
    
    if array.size(priceLabels) > 0
        for i = 0 to array.size(priceLabels) - 1
            label.delete(array.get(priceLabels, i))
        array.clear(priceLabels)

drawPriceLevel(float price, float refPrice, int currentSegment) =>
    if barstate.islast and shouldShowPrice(price, currentSegment, refPrice)
        text_position_x = bar_index + textXOffsetBars
        text_position_y = price + textYOffsetPrice
        
        newLine = line.new(bar_index + lineOffset, price, bar_index + lineOffset + lineLength, price, 
                 color=lineColor, style=lineStyle, width=lineThickness)
        array.push(priceLines, newLine)
        
        newLabel = label.new(x=text_position_x, y=text_position_y, text=str.tostring(price), 
                  textcolor=lineColor, style=label.style_none, size=textSize, xloc=xloc.bar_index)
        array.push(priceLabels, newLabel)

// ===== Daily High/Low Implementation =====
var line dailyHighLine = na
var line dailyLowLine = na
var label dailyHighLabel = na
var label dailyLowLabel = na

var float dailyHigh = na
var float dailyLow = na
var int dailyBarsCount = 0

isNewDay = ta.change(time("D")) != 0

if isNewDay
    dailyHigh := high
    dailyLow := low
    dailyBarsCount := 1
    
    if not na(dailyHighLine)
        line.delete(dailyHighLine)
    if not na(dailyLowLine)
        line.delete(dailyLowLine)
    if not na(dailyHighLabel)
        label.delete(dailyHighLabel)
    if not na(dailyLowLabel)
        label.delete(dailyLowLabel)
    
    if showDailyLevels
        dailyHighLine := line.new(bar_index, dailyHigh, bar_index + 1, dailyHigh, 
                 color=dailyHighColor, style=dailyLineStyleConverted, width=dailyLineThickness)
        dailyHighLabel := label.new(bar_index, dailyHigh, "DH: " + str.tostring(dailyHigh), 
                  color=dailyHighColor, style=label.style_label_left, textcolor=color.white, size=textSize)
        
        dailyLowLine := line.new(bar_index, dailyLow, bar_index + 1, dailyLow, 
                 color=dailyLowColor, style=dailyLineStyleConverted, width=dailyLineThickness)
        dailyLowLabel := label.new(bar_index, dailyLow, "DL: " + str.tostring(dailyLow), 
                  color=dailyLowColor, style=label.style_label_left, textcolor=color.white, size=textSize)
else
    if high > dailyHigh
        dailyHigh := high
        if not na(dailyHighLine)
            line.set_xy1(dailyHighLine, bar_index - dailyBarsCount, dailyHigh)
            line.set_xy2(dailyHighLine, bar_index, dailyHigh)
        if not na(dailyHighLabel)
            label.set_xy(dailyHighLabel, bar_index, dailyHigh)
            label.set_text(dailyHighLabel, "DH: " + str.tostring(dailyHigh))
    
    if low < dailyLow
        dailyLow := low
        if not na(dailyLowLine)
            line.set_xy1(dailyLowLine, bar_index - dailyBarsCount, dailyLow)
            line.set_xy2(dailyLowLine, bar_index, dailyLow)
        if not na(dailyLowLabel)
            label.set_xy(dailyLowLabel, bar_index, dailyLow)
            label.set_text(dailyLowLabel, "DL: " + str.tostring(dailyLow))
    
    dailyBarsCount += 1

    if not na(dailyHighLine)
        line.set_xy2(dailyHighLine, bar_index, dailyHigh)
    if not na(dailyLowLine)
        line.set_xy2(dailyLowLine, bar_index, dailyLow)

// ===== Alert System =====
checkPriceNearLevel(float price, float level) =>
    math.abs(price - level) <= alertPriceTolerance

priceLevelAlert = false
dailyHighAlert = false
dailyLowAlert = false
bothConditionsAlert = false
currentLevel = 0.0

if alertOnPriceLevels and array.size(prices) > 0
    for i = 0 to array.size(prices) - 1
        currentPrice = array.get(prices, i)
        if checkPriceNearLevel(close, currentPrice)
            priceLevelAlert := true
            currentLevel := currentPrice
            break

if alertOnDailyLevels and not na(dailyHigh) and not na(dailyLow)
    if checkPriceNearLevel(close, dailyHigh)
        dailyHighAlert := true
    if checkPriceNearLevel(close, dailyLow)
        dailyLowAlert := true

if alertOnBothConditions and priceLevelAlert and (dailyHighAlert or dailyLowAlert)
    bothConditionsAlert := true

alertcondition(priceLevelAlert, "Price Level Reached", "Price reached a predefined level")
alertcondition(dailyHighAlert, "Daily High Reached", "Price reached daily high")
alertcondition(dailyLowAlert, "Daily Low Reached", "Price reached daily low")
alertcondition(bothConditionsAlert, "Both Conditions Met", "Price reached both a level AND daily high/low")

if (priceLevelAlert or dailyHighAlert or dailyLowAlert or bothConditionsAlert)
    message = ""
    
    if bothConditionsAlert
        message := "DOUBLE ALERT: Price reached level " + str.tostring(currentLevel) + " AND "
        message += dailyHighAlert ? "Daily High: " + str.tostring(dailyHigh) : "Daily Low: " + str.tostring(dailyLow)
    else
        if priceLevelAlert
            message := "Price reached level: " + str.tostring(currentLevel)
        if dailyHighAlert
            if message != ""
                message += " and "
            message += "Daily High: " + str.tostring(dailyHigh)
        if dailyLowAlert
            if message != ""
                message += " and "
            message += "Daily Low: " + str.tostring(dailyLow)
    
    alert(message, alert.freq_once_per_bar_close)

// ===== Main Execution =====
if barstate.islast
    cleanupPriceLevels()
    refPrice = getReferencePrice()
    currentSegment = findCurrentSegment(refPrice + bufferPoints)
    
    if array.size(prices) > 0
        for i = 0 to array.size(prices) - 1
            drawPriceLevel(array.get(prices, i), refPrice, currentSegment)